<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üåä Chat Oce√¢nico ‚Äî Nemo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/chat/style.css">
</head>
<body>
  <header>üåä Chat Oce√¢nico ‚Äî Nemo</header>
  <div class="app">
    <div id="messages"></div>
    <div id="welcome">
      <span style="font-size:1.05rem">Bem-vindo ao <strong>Chat Oce√¢nico</strong></span>
      <span class="muted">Sou <strong>Nemo</strong>, especialista em cultura oce√¢nica. Experimente: "O que √© a mar√©?"</span>
    </div>
  </div>

  <!-- floating input bubble -->
  <div class="floating-input" role="region" aria-label="Entrada de mensagem">
    <form id="chat-form" autocomplete="off">
      <input id="user-input" name="message" type="text" placeholder="Pergunte algo sobre o oceano..." aria-label="Mensagem" />
      <button class="send-btn" type="submit">Enviar</button>
    </form>
  </div>

<script type="module">
  // Importa a biblioteca Google Generative AI
  import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

  // IMPORTANTE: Em produ√ß√£o, NUNCA exponha sua API KEY diretamente no frontend.
  // Para fins de demonstra√ß√£o, deixamos a chave aqui.
  // Em um ambiente real, use um backend para fazer as chamadas √† API.
  const API_KEY = "AIzaSyA3tKXVdHSQ3nAwIxbGVbcEnXoLlOtZbZQ"; // A chave ser√° fornecida pelo ambiente em tempo de execu√ß√£o
  const genAI = new GoogleGenerativeAI(API_KEY);
  // Inicializa o modelo Gemini-2.5-flash
  const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash-preview-05-20' });

  // Seletores de elementos HTML
  const form = document.getElementById('chat-form');
  const input = document.getElementById('user-input');
  const messages = document.getElementById('messages');
  const welcome = document.getElementById('welcome');

  // Hist√≥rico da conversa para manter o contexto
  let chatHistory = [];

  // Prompt de controle inicial para definir o comportamento do Nemo
  const systemPrompt = `Voc√™ √© Nemo, uma assistente chamada Nemo especializada em preserva√ß√£o oce√¢nica. Responda de forma clara, amig√°vel e curta quando poss√≠vel. Use **negrito** (markdown) para t√≠tulos ou palavras-chave importantes.`;

  // Adiciona o prompt do sistema ao hist√≥rico como a primeira "mensagem"
  // Embora n√£o seja exibido, ele informa o modelo sobre o papel do Nemo
  chatHistory.push({ role: "user", parts: [{ text: systemPrompt }] });


  /**
   * Cria e retorna um elemento de bolha de mensagem (div).
   * @param {string} text - O texto da mensagem.
   * @param {string} who - O remetente da mensagem ('bot' ou 'user').
   * @returns {HTMLDivElement} - O elemento div da bolha de mensagem.
   */
  function createBubble(text, who = 'bot') {
    const div = document.createElement('div');
    // Adiciona classes CSS para estiliza√ß√£o e alinhamento
    div.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');
    const inner = document.createElement('div');
    inner.style.whiteSpace = 'pre-wrap'; // Preserva quebras de linha e espa√ßos

    // Converte o formato markdown de negrito (**) para tags <strong> HTML
    // Garante que o texto seja seguro, evitando XSS
    const safeHTML = String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Converte **texto** para <strong>texto</strong>

    inner.innerHTML = safeHTML;
    div.appendChild(inner);
    return div;
  }

  // Adiciona um listener para o evento de submit do formul√°rio de chat
  form.addEventListener('submit', async (e) => {
    e.preventDefault(); // Impede o comportamento padr√£o de recarregar a p√°gina
    const text = input.value.trim(); // Obt√©m o texto do input, removendo espa√ßos extras
    if (!text) return; // Se o input estiver vazio, n√£o faz nada

    // Remove a mensagem de boas-vindas se ela estiver presente
    if (welcome && welcome.parentNode) {
      welcome.remove();
    }

    // Adiciona a mensagem do usu√°rio ao chat vis√≠vel
    messages.appendChild(createBubble(text, 'user'));
    // Adiciona a mensagem do usu√°rio ao hist√≥rico de chat
    chatHistory.push({ role: "user", parts: [{ text: text }] });
    input.value = ''; // Limpa o input
    messages.scrollTop = messages.scrollHeight; // Rola para o final das mensagens

    // Adiciona uma mensagem de "Nemo est√° pensando..." enquanto a IA gera a resposta
    const thinking = createBubble('Nemo est√° pensando...', 'bot');
    messages.appendChild(thinking);
    messages.scrollTop = messages.scrollHeight; // Rola novamente para exibir a mensagem de "pensando"

    try {
      // Realiza a chamada √† API Gemini para gerar conte√∫do, passando o hist√≥rico completo
      const payload = { contents: chatHistory };
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();

      // Extrai o texto da resposta da IA de diferentes estruturas poss√≠veis do retorno da API
      let botText = '';
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        botText = result.candidates[0].content.parts[0].text;
      } else {
        // Fallback caso a estrutura da resposta seja inesperada
        botText = 'Desculpe, n√£o consegui gerar uma resposta. Tente novamente.';
        console.error('Estrutura de resposta da API inesperada:', result);
      }

      // Remove a mensagem de "Nemo est√° pensando..."
      if (thinking && thinking.parentNode) thinking.parentNode.removeChild(thinking);

      // Adiciona a resposta formatada da IA ao chat vis√≠vel
      messages.appendChild(createBubble(botText || 'Desculpe, sem resposta da IA.', 'bot'));
      // Adiciona a resposta da IA ao hist√≥rico de chat
      chatHistory.push({ role: "model", parts: [{ text: botText }] }); // 'model' √© a role para o bot
      messages.scrollTop = messages.scrollHeight; // Rola para o final das mensagens
    } catch (err) {
      console.error('Erro ao consultar a API:', err);
      // Remove a mensagem de "pensando" em caso de erro
      if (thinking && thinking.parentNode) thinking.parentNode.removeChild(thinking);
      // Adiciona uma mensagem de erro ao chat
      messages.appendChild(createBubble('Erro ao consultar a API. Veja o console para detalhes.', 'bot'));
      messages.scrollTop = messages.scrollHeight;
      // Em caso de erro, remove a √∫ltima mensagem do usu√°rio do hist√≥rico para evitar loop de erro
      chatHistory.pop();
    }
  });

  // Garante que o campo de input esteja focado quando a p√°gina carrega
  window.addEventListener('load', () => input.focus());
</script>
</body>
</html>
